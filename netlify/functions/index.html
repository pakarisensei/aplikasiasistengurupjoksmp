<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asisten Digital Guru PJOK SMP (Versi Pro)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f9ff; /* sky-50 */
        }
        .prose { max-width: 100%; font-family: 'Poppins', sans-serif; }
        .prose h1, .prose h2, .prose h3, .prose h4, .prose h5 { font-family: 'Poppins', sans-serif; font-weight: 700; margin-bottom: 0.75rem; }
        .prose p, .prose ul, .prose ol { margin-top: 0; margin-bottom: 1rem; }
        .prose .main-title { text-align:center; font-size:1.8em; margin-bottom:0.25rem; }
        .prose .subtitle { text-align:center; font-size:1.4em; margin-top:0; font-weight:600; }
        .prose .main-divider { border-top:1px solid black; margin:1.5rem 0; }
        .prose .section-title {
            font-size: 1.5rem;
            font-weight: 800;
            padding: 0.5rem 1rem;
            background-color: #ecfdf5; /* emerald-100 */
            color: #065f46; /* emerald-800 */
            border-left: 5px solid #047857; /* emerald-700 */
            margin-top: 2.5rem;
            margin-bottom: 1.5rem;
        }
        .prose .subsection-title {
            font-size: 1.15rem;
            font-weight: 700;
            color: #333;
            margin-top: 2rem;
            margin-bottom: 1rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .info-box { background-color: #e0f2fe; border-left: 4px solid #0369a1; padding: 1rem; margin-top: 1rem; border-radius: 0.5rem; }
        .lampiran-box { border: 1px solid #e5e7eb; padding: 1.25rem; border-radius: 8px; margin-top: 1rem; background-color: #fafafa; }
        
        .prose table { width: 100%; border-collapse: collapse; margin-top: 1em; }
        .prose th, .prose td { border: 1px solid #d1d5db; padding: 0.75rem; text-align: left; }
        .prose th { background-color: #f9fafb; font-weight: 600; }
        .prose .info-table td:first-child { font-weight: 600; background-color: #f9fafb; width: 30%; }
        
        #gemini-modal-content h1, #gemini-modal-content h2, #gemini-modal-content h3 { font-weight: bold; margin-top: 1.25rem; margin-bottom: 0.5rem; }
        #gemini-modal-content h1 { font-size: 1.5rem; } #gemini-modal-content h2 { font-size: 1.35rem; } #gemini-modal-content h3 { font-size: 1.2rem; }
        #gemini-modal-content p { margin-top: 0; margin-bottom: 1rem; line-height: 1.6; }
        #gemini-modal-content ul, #gemini-modal-content ol { list-style-position: outside; padding-left: 1.5rem; margin-top: 1rem; margin-bottom: 1rem; }
        #gemini-modal-content li { margin-bottom: 0.5rem; }
        #gemini-modal-content strong { font-weight: 700; } #gemini-modal-content em { font-style: italic; }
        #gemini-modal-content a { color: #0e7490; text-decoration: underline; }

        .no-print { display: block; }
        @media print { .no-print { display: none; } }
    </style>
</head>
<body class="bg-sky-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8 p-8 rounded-xl bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg no-print">
            <h1 class="text-4xl md:text-5xl font-extrabold">Asisten Digital Guru PJOK SMP</h1>
            <p class="text-indigo-200 mt-3 text-lg">Merancang Modul Ajar, Kuis, & Ide Coding PJOK jenjang SMP dengan cepat dan efisien.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <!-- Kolom Pengaturan -->
            <div class="lg:col-span-4 no-print">
                <form id="settingsForm" class="space-y-6 sticky top-8">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-xl font-bold mb-4 border-b pb-2 text-sky-700">Informasi Dasar</h3>
                        <div class="space-y-4">
                            <div><label for="nama-penyusun" class="block text-sm font-medium text-gray-700">Nama Guru</label><input type="text" id="nama-penyusun" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500" value="Nama Guru PJOK, S.Pd."></div>
                            <div><label for="guru-nip" class="block text-sm font-medium text-gray-700">NIP Guru</label><input type="text" id="guru-nip" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500" value="198XXXXX XXXXXX X XXX"></div>
                            <div><label for="kepsek-nama" class="block text-sm font-medium text-gray-700">Nama Kepala Sekolah</label><input type="text" id="kepsek-nama" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500" value="Nama Kepala Sekolah, M.Pd."></div>
                            <div><label for="kepsek-nip" class="block text-sm font-medium text-gray-700">NIP Kepala Sekolah</label><input type="text" id="kepsek-nip" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500" value="197XXXXX XXXXXX X XXX"></div>
                            <div><label for="institusi" class="block text-sm font-medium text-gray-700">Institusi</label><input type="text" id="institusi" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500" value="Nama Sekolah"></div>
                            <div><label for="lokasi-ttd" class="block text-sm font-medium text-gray-700">Tempat Tanda Tangan</label><input type="text" id="lokasi-ttd" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500" value="Makassar"></div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-xl font-bold mb-4 border-b pb-2 text-sky-700">Pengaturan Modul PJOK</h3>
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div><label for="fase" class="block text-sm font-medium text-gray-700">Fase</label><select id="fase" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500 bg-gray-100" disabled><option value="D" selected>D (SMP)</option></select></div>
                                <div><label for="kelas" class="block text-sm font-medium text-gray-700">Kelas</label><select id="kelas" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500"></select></div>
                            </div>
                            <div><label for="semester" class="block text-sm font-medium text-gray-700">Semester</label><select id="semester" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500"><option value="Ganjil" selected>Ganjil</option><option value="Genap">Genap</option></select></div>
                            <div><label for="elemen-cp" class="block text-sm font-medium text-gray-700">Elemen CP</label><select id="elemen-cp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500"></select></div>
                            <div><label for="materi-pembelajaran" class="block text-sm font-medium text-gray-700">Materi Pembelajaran</label><select id="materi-pembelajaran" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500"></select></div>
                            <div><label for="materi-spesifik" class="block text-sm font-medium text-gray-700">Fokus Pembelajaran (Materi Spesifik)</label><input type="text" id="materi-spesifik" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500" placeholder="Contoh: Passing Bawah Bola Voli"></div>
                            <div>
                                <label for="model-pembelajaran" class="block text-sm font-medium text-gray-700">Model Pembelajaran</label>
                                <select id="model-pembelajaran" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500"></select>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label for="jumlah-pertemuan" class="block text-sm font-medium text-gray-700">Jml. Pertemuan</label><input type="number" id="jumlah-pertemuan" value="2" min="1" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500"></div>
                                <div><label for="jp-per-pertemuan" class="block text-sm font-medium text-gray-700">JP / Pertemuan</label><input type="number" id="jp-per-pertemuan" value="2" min="1" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500"></div>
                            </div>
                            <div><label for="menit-per-jp" class="block text-sm font-medium text-gray-700">Menit per JP</label><input type="number" id="menit-per-jp" value="40" min="1" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500"></div>
                        </div>
                    </div>
                    
                    <button type="submit" class="w-full bg-sky-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 flex items-center justify-center transition-all duration-200">
                        <i data-lucide="book-open" class="mr-2"></i>
                        Buat Modul Ajar
                    </button>
                    <div id="loader" class="hidden text-center mt-4">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-sky-600 mx-auto"></div>
                        <p class="mt-2 text-gray-600">Asisten sedang merancang...</p>
                    </div>
                </form>
            </div>

            <!-- Kolom Hasil -->
            <div class="lg:col-span-8">
                <div id="outputContainer" class="bg-white p-2 sm:p-4 md:p-8 rounded-xl shadow-lg min-h-screen">
                    <div id="placeholder" class="flex items-center justify-center h-full">
                        <div class="text-center text-gray-400">
                            <i data-lucide="file-text" class="mx-auto h-16 w-16 text-gray-300"></i>
                            <h3 class="mt-2 text-lg font-medium">Modul Ajar PJOK Anda Akan Tampil di Sini</h3>
                            <p class="mt-1 text-sm">Lengkapi formulir, dan biarkan Asisten merancang pengalaman belajar.</p>
                        </div>
                    </div>
                    <div id="modulContent" class="prose max-w-none"></div>
                    <div id="action-buttons-wrapper" class="hidden no-print">
                        <div class="flex flex-wrap gap-2 my-6 border-t pt-6">
                            <button id="copy-btn" class="flex items-center bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 text-sm"><i data-lucide="copy" class="mr-2 h-4 w-4"></i>Salin</button>
                            <button id="back-btn" class="flex items-center bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 text-sm"><i data-lucide="arrow-left" class="mr-2 h-4 w-4"></i>Buat Baru</button>
                        </div>
                        <div id="gemini-features" class="mt-4 pt-6 border-t-2 border-dashed border-gray-300">
                            <h3 class="text-xl font-bold text-sky-800 text-center mb-2">Perkaya Modul dengan Fitur Canggih</h3>
                            <p class="text-center text-gray-600 mb-6">Gunakan tombol di bawah untuk meminta Asisten Guru membuat konten tambahan.</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <button id="gemini-warmup-btn" class="bg-teal-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-600 flex items-center justify-center"><i data-lucide="flame" class="mr-2 h-5 w-5"></i>Ide Pemanasan</button>
                                <button id="gemini-materi-btn" class="bg-amber-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-amber-600 flex items-center justify-center"><i data-lucide="book-open-check" class="mr-2 h-5 w-5"></i>Materi Ajar Mendalam</button>
                                <button id="gemini-quiz-btn" class="bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600 flex items-center justify-center"><i data-lucide="puzzle" class="mr-2 h-5 w-5"></i>Kuis Interaktif</button>
                                <button id="gemini-coding-btn" class="bg-gray-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-800 flex items-center justify-center"><i data-lucide="code-2" class="mr-2 h-5 w-5"></i>Ide Coding PJOK</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gemini Modal for AI Content -->
    <div id="gemini-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center p-4 z-50 hidden no-print">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl transform transition-all max-h-[90vh] flex flex-col">
            <div class="p-5 border-b border-gray-200 flex justify-between items-center">
                <h2 id="gemini-modal-title" class="text-xl font-bold text-gray-800">Bantuan Asisten Guru</h2>
                <button id="gemini-modal-close" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="h-6 w-6"></i></button>
            </div>
            <div id="gemini-modal-content" class="p-6 overflow-y-auto prose max-w-none"></div>
            <div class="p-4 bg-gray-50 border-t border-gray-200 rounded-b-2xl"><button id="gemini-modal-copy" class="w-full bg-sky-600 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-sky-700 flex items-center justify-center">Salin Teks</button></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            
            // --- DATABASE PJOK SMP (INTI APLIKASI) ---
            const capaianPerElemen = {
                'Terampil Bergerak': { D: "Peserta didik menganalisis dan menghaluskan keterampilan gerak serta mentransfernya ke dalam berbagai situasi gerak. Peserta didik menyusun dan memeragakan strategi gerak yang dapat dimanfaatkan untuk meningkatkan capaian keterampilan gerak. Peserta didik memeragakan dan menjelaskan konsep gerak yang dapat dimanfaatkan untuk meningkatkan capaian keterampilan gerak." },
                'Belajar melalui Gerak': { D: "Peserta didik mengemukakan dan membuktikan strategi gerak yang paling efektif dalam situasi gerak yang berbeda. Peserta didik menginvestigasi modifikasi peralatan, peraturan, dan sistem skoring yang mendukung fair play dan partisipasi inklusif. Peserta didik menerapkan kepemimpinan, kolaborasi, dan proses pengambilan keputusan kelompok ketika berpartisipasi di dalam berbagai aktivitas jasmani." },
                'Bergaya Hidup Aktif': { D: "Peserta didik berpartisipasi dalam aktivitas jasmani untuk menggambarkan reaksi tubuh terhadap berbagai tingkat intensitas yang berbeda. Peserta didik berpartisipasi dalam aktivitas jasmani yang menyehatkan di luar ruang dan/atau lingkungan alam dan menggambarkan sumber daya yang dibutuhkan untuk meningkatkan partisipasi. Peserta didik menjelaskan dan mengusulkan strategi peningkatan aktivitas jasmani dan pencegahan perilaku sedenter." },
                'Memilih Hidup yang Menyehatkan': { D: "Peserta didik menganalisis risiko kesehatan akibat gaya hidup dan merancang tindakan pencegahan melalui aktivitas jasmani berdasarkan rekomendasi otoritas kesehatan. Peserta didik merancang pilihan makanan sehat berdasarkan analisis kandungan gizi sesuai kebutuhan aktivitas jasmani. Peserta didik mempraktikkan prosedur untuk menangani cedera yang berisiko terhadap kesehatan dan keselamatan berdasarkan prinsip pertolongan pertama." }
            };
            const elemenList = [ 'Terampil Bergerak', 'Belajar melalui Gerak', 'Bergaya Hidup Aktif', 'Memilih Hidup yang Menyehatkan' ];
            const materiByKelas = {
                '7': { 'sepak-bola-7': { text: 'Permainan Sepak Bola', elemenTerkait: 'Terampil Bergerak', saranSpesifik: 'Teknik Dasar Menendang' }, 'bola-voli-7': { text: 'Permainan Bola Voli', elemenTerkait: 'Terampil Bergerak', saranSpesifik: 'Passing Bawah dan Atas' }, 'bola-basket-7': { text: 'Permainan Bola Basket', elemenTerkait: 'Terampil Bergerak', saranSpesifik: 'Dribbling dan Chest Pass' }, 'kasti-7': { text: 'Permainan Kasti', elemenTerkait: 'Terampil Bergerak', saranSpesifik: 'Melempar dan Menangkap Bola' }, 'bulutangkis-7': { text: 'Permainan Bulutangkis', elemenTerkait: 'Terampil Bergerak', saranSpesifik: 'Pukulan Servis' }, 'tenis-meja-7': { text: 'Permainan Tenis Meja', elemenTerkait: 'Terampil Bergerak', saranSpesifik: 'Pukulan Forehand' }, 'atletik-jalan-cepat-7': { text: 'Aktivitas Atletik Jalan Cepat', elemenTerkait: 'Terampil Bergerak', saranSpesifik: 'Gerak Langkah dan Ayunan Lengan' }, 'atletik-lari-pendek-7': { text: 'Aktivitas Atletik Lari Jarak Pendek', elemenTerkait: 'Terampil Bergerak', saranSpesifik: 'Teknik Start Jongkok' }, 'atletik-lompat-jauh-7': { text: 'Aktivitas Atletik Lompat Jauh', elemenTerkait: 'Terampil Bergerak', saranSpesifik: 'Teknik Awalan dan Tolakan' }, 'atletik-tolak-peluru-7': { text: 'Aktivitas Atletik Tolak Peluru (The Short Pot)', elemenTerkait: 'Terampil Bergerak', saranSpesifik: 'Teknik Memegang dan Menolak Peluru' }, 'beladiri-silat-7': { text: 'Seni Bela Diri (Pencak Silat)', elemenTerkait: 'Terampil Bergerak', saranSpesifik: 'Sikap Kuda-kuda dan Pukulan' }, 'kebugaran-jasmani-7': { text: 'Kebugaran Jasmani', elemenTerkait: 'Bergaya Hidup Aktif', saranSpesifik: 'Latihan Kekuatan Otot' }, 'senam-lantai-7': { text: 'Senam Lantai (Guling Depan dan Guling Belakang Serta Keseimbangan)', elemenTerkait: 'Terampil Bergerak', saranSpesifik: 'Rangkaian Guling Depan dan Belakang' }, 'senam-irama-7': { text: 'Senam Irama', elemenTerkait: 'Terampil Bergerak', saranSpesifik: 'Gerak Langkah Dasar' }, 'kebugaran-kesehatan-7': { text: 'Aktivitas Kebugaran untuk Kesehatan dan pengukurannya', elemenTerkait: 'Bergaya Hidup Aktif', saranSpesifik: 'Tes Kebugaran Jasmani Indonesia (TKJI)' }, 'pola-makan-sehat-7': { text: 'Pola Makan Sehat Begizi dan Seimbang', elemenTerkait: 'Memilih Hidup yang Menyehatkan', saranSpesifik: 'Konsep Isi Piringku' } },
                '8': { 'sepak-bola-8': { text: 'Permainan Sepak Bola', elemenTerkait: 'Terampil Bergerak', saranSpesifik: 'Kombinasi Gerak Spesifik' }, 'bola-voli-8': { text: 'Permainan Bola Voli', elemenTerkait: 'Terampil Bergerak', saranSpesifik: 'Teknik Servis Atas' }, 'bola-basket-8': { text: 'Permainan Bola Basket', elemenTerkait: 'Terampil Bergerak', saranSpesifik: 'Teknik Shooting (Lay-up)' }, 'softball-8': { text: 'Permainan Softball', elemenTerkait: 'Terampil Bergerak', saranSpesifik: 'Teknik Memegang Stik dan Memukul' }, 'bulutangkis-8': { text: 'Permainan Bulutangkis', elemenTerkait: 'Terampil Bergerak', saranSpesifik: 'Pukulan Lob dan Smash' }, 'tenis-meja-8': { text: 'Permainan Tenis Meja', elemenTerkait: 'Terampil Bergerak', saranSpesifik: 'Pukulan Backhand dan Servis' }, 'atletik-jalan-cepat-8': { text: 'Aktivitas Atletik Jalan Cepat', elemenTerkait: 'Terampil Bergerak', saranSpesifik: 'Analisis Gerak Jalan Cepat' }, 'atletik-lari-pendek-8': { text: 'Aktivitas Atletik Lari Jarak Pendek', elemenTerkait: 'Terampil Bergerak', saranSpesifik: 'Analisis Gerak Lari Cepat' }, 'atletik-lompat-jauh-8': { text: 'Aktivitas Atletik Lompat Jauh', elemenTerkait: 'Terampil Bergerak', saranSpesifik: 'Teknik Melayang dan Mendarat' }, 'atletik-tolak-peluru-8': { text: 'Aktivitas Atletik Tolak Peluru', elemenTerkait: 'Terampil Bergerak', saranSpesifik: 'Analisis Gerak Tolak Peluru' }, 'beladiri-silat-8': { text: 'Seni Bela Diri (Pencak Silat)', elemenTerkait: 'Terampil Bergerak', saranSpesifik: 'Kombinasi Pukulan dan Tendangan' }, 'kebugaran-jasmani-8': { text: 'Kebugaran Jasmani (Konsep dan Latihan)', elemenTerkait: 'Bergaya Hidup Aktif', saranSpesifik: 'Konsep Latihan Daya Tahan' }, 'senam-lantai-8': { text: 'Senam Lantai (Meroda dan Guling Lenting)', elemenTerkait: 'Terampil Bergerak', saranSpesifik: 'Teknik Dasar Meroda' }, 'gerak-berirama-8': { text: 'Gerak Berirama (Langkah Kaki dan Ayunan Lengan)', elemenTerkait: 'Terampil Bergerak', saranSpesifik: 'Kombinasi Gerak Langkah dan Ayunan' }, 'renang-dada-8': { text: 'Aktivitas Air (Renang Gaya Dada)', elemenTerkait: 'Terampil Bergerak', saranSpesifik: 'Koordinasi Gerak Renang Gaya Dada' }, 'pergaulan-bebas-8': { text: 'Pencegahan Pergaulan Bebas (Etika dan Solusi Pergaulan Sehat)', elemenTerkait: 'Memilih Hidup yang Menyehatkan', saranSpesifik: 'Analisis Dampak Pergaulan Bebas' }, 'keselamatan-jalan-raya-8': { text: 'Keselamatan di Jalan Raya (Rambu, Marka, dan Etika Berkendara)', elemenTerkait: 'Memilih Hidup yang Menyehatkan', saranSpesifik: 'Identifikasi Rambu Lalu Lintas' } },
                '9': { 'sepak-bola-9': { text: 'Permainan Sepak Bola', elemenTerkait: 'Belajar melalui Gerak', saranSpesifik: 'Strategi dan Taktik Permainan' }, 'bola-voli-9': { text: 'Permainan Bola Voli', elemenTerkait: 'Belajar melalui Gerak', saranSpesifik: 'Strategi Menyerang dan Bertahan' }, 'bola-basket-9': { text: 'Permainan Bola Basket', elemenTerkait: 'Belajar melalui Gerak', saranSpesifik: 'Pola Permainan Sederhana' }, 'rounders-9': { text: 'Permainan Rounders', elemenTerkait: 'Belajar melalui Gerak', saranSpesifik: 'Peraturan dan Strategi Bermain' }, 'bulutangkis-9': { text: 'Permainan Bulutangkis', elemenTerkait: 'Belajar melalui Gerak', saranSpesifik: 'Taktik Permainan Ganda' }, 'tenis-meja-9': { text: 'Permainan Tenis Meja', elemenTerkait: 'Belajar melalui Gerak', saranSpesifik: 'Taktik Permainan Tunggal' }, 'atletik-jalan-cepat-9': { text: 'Aktivitas Atletik Jalan Cepat', elemenTerkait: 'Bergaya Hidup Aktif', saranSpesifik: 'Perancangan Program Latihan' }, 'atletik-lari-estafet-9': { text: 'Aktivitas Atletik Lari Jarak Pendek (Lari Sambung/Estafet)', elemenTerkait: 'Terampil Bergerak', saranSpesifik: 'Teknik Pemberian dan Penerimaan Tongkat' }, 'atletik-lompat-jauh-9': { text: 'Aktivitas Atletik Lompat Jauh', elemenTerkait: 'Bergaya Hidup Aktif', saranSpesifik: 'Analisis Hasil Lompatan' }, 'atletik-lempar-cakram-9': { text: 'Aktivitas Atletik Lempar Cakram', elemenTerkait: 'Terampil Bergerak', saranSpesifik: 'Teknik Awalan dan Lemparan' }, 'beladiri-silat-9': { text: 'Seni Bela Diri (Pencak Silat)', elemenTerkait: 'Belajar melalui Gerak', saranSpesifik: 'Kombinasi Gerak dalam Jurus Sederhana' }, 'kebugaran-jasmani-9': { text: 'Kebugaran Jasmani', elemenTerkait: 'Bergaya Hidup Aktif', saranSpesifik: 'Evaluasi Tingkat Kebugaran' }, 'senam-lantai-kombinasi-9': { text: 'Senam Lantai (Gerak Kombinasi Rangkaian Senam Lantai)', elemenTerkait: 'Terampil Bergerak', saranSpesifik: 'Merangkai Gerakan Guling dan Keseimbangan' }, 'gerak-berirama-aerobik-9': { text: 'Gerak Berirama (Menggunakan Senam Aerobik)', elemenTerkait: 'Bergaya Hidup Aktif', saranSpesifik: 'Menciptakan Rangkaian Senam Aerobik' }, 'renang-bebas-9': { text: 'Aktivitas Air (Renang Gaya Bebas)', elemenTerkait: 'Terampil Bergerak', saranSpesifik: 'Koordinasi Gerak Renang Gaya Bebas' }, 'p3k-9': { text: 'Pertolongan Pertama pada Kecelakaan (P3K)', elemenTerkait: 'Memilih Hidup yang Menyehatkan', saranSpesifik: 'Penanganan Cedera Ringan (Luka, Memar)' }, 'aktivitas-fisik-penyakit-9': { text: 'Aktivitas Fisik dalam Pencegahan Penyakit', elemenTerkait: 'Memilih Hidup yang Menyehatkan', saranSpesifik: 'Hubungan Aktivitas Fisik dan Penyakit Tidak Menular' } }
            };
            const modelPembelajaranList = [ "Direct Instruction", "Tactical Games Model", "Sport Education Model (SEM)", "Cooperative Learning", "Project-Based Learning (PjBL)", "Problem-Based Learning (PBL)", "Inquiry Learning", "Discovery Learning", "Experiential Learning", "Blended Learning" ];
            const profilLulusanDatabase = { base: ['Keimanan', 'Kemandirian', 'Kesehatan'], desc: { 'Keimanan': 'Terintegrasi melalui kegiatan berdoa sebelum dan sesudah pelajaran serta menumbuhkan rasa syukur atas kesehatan tubuh.', 'Kewargaan': 'Dikembangkan melalui sportivitas, kepatuhan pada aturan main, dan menghargai teman maupun lawan.', 'Penalaran Kritis': 'Diasah saat siswa menganalisis taktik, mengevaluasi gerakan, dan memecahkan masalah dalam situasi permainan.', 'Kreativitas': 'Didorong saat siswa merancang variasi latihan, strategi permainan, atau menciptakan rangkaian gerak baru.', 'Kolaborasi': 'Dibangun melalui kerja sama tim, komunikasi efektif, dan memberikan umpan balik konstruktif kepada rekan.', 'Kemandirian': 'Tumbuh saat siswa mengambil inisiatif untuk berlatih, mengelola peralatannya sendiri, dan bertanggung jawab atas kemajuan belajarnya.', 'Kesehatan': 'Menjadi fokus utama dengan memahami manfaat aktivitas fisik bagi tubuh dan menerapkan pola hidup sehat.', 'Komunikasi': 'Dilatih secara verbal dan non-verbal saat berinteraksi dengan teman satu tim, menyampaikan ide, dan memahami isyarat dalam permainan.' }, byElemen: { 'Terampil Bergerak': ['Penalaran Kritis', 'Kemandirian'], 'Belajar melalui Gerak': ['Kolaborasi', 'Komunikasi', 'Kewargaan'], 'Bergaya Hidup Aktif': ['Kesehatan', 'Kemandirian'], 'Memilih Hidup yang Menyehatkan': ['Penalaran Kritis', 'Kesehatan', 'Kolaborasi'] } };
            const kelasByFase = { D: [7, 8, 9] };

            // --- DATABASE SINTAKS PEMBELAJARAN (KONTEKSTUAL) ---
            const sintaksDatabase = {
                'Direct Instruction': [ { phase: 'Fase 1: Menyampaikan Tujuan', activity: 'Guru menjelaskan tujuan pembelajaran dan mempersiapkan siswa.', experience: 'memahami' }, { phase: 'Fase 2: Demonstrasi (I Do)', activity: 'Guru mendemonstrasikan keterampilan {materi_spesifik} dengan benar dan jelas.', experience: 'memahami' }, { phase: 'Fase 3: Latihan Terbimbing (We Do)', activity: 'Siswa meniru gerakan dengan bimbingan dan umpan balik langsung dari guru.', experience: 'mengaplikasi' }, { phase: 'Fase 4: Latihan Mandiri (You Do)', activity: 'Siswa berlatih secara mandiri atau berpasangan untuk memantapkan gerakan.', experience: 'mengaplikasi' }, { phase: 'Fase 5: Evaluasi & Refleksi', activity: 'Guru mengevaluasi penguasaan keterampilan dan mengajak siswa merefleksikan kesulitan yang dihadapi.', experience: 'merefleksi' } ],
                'Tactical Games Model': [ { phase: 'Fase 1: Permainan Awal', activity: 'Siswa memainkan permainan yang dimodifikasi terkait {materi_spesifik} dengan aturan sederhana.', experience: 'mengaplikasi' }, { phase: 'Fase 2: Pertanyaan Taktis', activity: 'Guru mengajukan pertanyaan pemantik: "Bagaimana cara agar tim kita bisa mencetak skor?" atau "Apa yang membuat kita sulit merebut bola?"', experience: 'memahami' }, { phase: 'Fase 3: Praktik Keterampilan', activity: 'Siswa berlatih keterampilan spesifik ({materi_spesifik}) yang dibutuhkan untuk memecahkan masalah taktis.', experience: 'mengaplikasi' }, { phase: 'Fase 4: Permainan Akhir', activity: 'Siswa kembali memainkan permainan dengan menerapkan pemahaman taktis dan keterampilan yang baru dilatih.', experience: 'mengaplikasi' }, { phase: 'Fase 5: Refleksi Kelompok', activity: 'Setiap kelompok merefleksikan strategi yang berhasil dan yang perlu diperbaiki.', experience: 'merefleksi' } ],
                'Cooperative Learning': [ { phase: 'Fase 1: Penyampaian Tujuan', activity: 'Guru menjelaskan tujuan pembelajaran dan pentingnya kerja sama tim.', experience: 'memahami' }, { phase: 'Fase 2: Pembentukan Kelompok', activity: 'Siswa dibagi menjadi kelompok-kelompok kecil yang heterogen.', experience: 'mengaplikasi' }, { phase: 'Fase 3: Kerja Kelompok', activity: 'Setiap kelompok diberi tugas atau tantangan gerak yang melibatkan {materi_spesifik} untuk diselesaikan bersama.', experience: 'mengaplikasi' }, { phase: 'Fase 4: Presentasi/Kompetisi Antar Kelompok', activity: 'Setiap kelompok menampilkan hasil kerja atau berkompetisi secara sportif.', experience: 'mengaplikasi' }, { phase: 'Fase 5: Evaluasi & Refleksi Tim', activity: 'Guru bersama siswa mengevaluasi proses kerja sama dan hasil yang dicapai setiap kelompok.', experience: 'merefleksi' } ],
                'Project-Based Learning (PjBL)': [ { phase: 'Fase 1: Pertanyaan Mendasar', activity: 'Guru mengajukan pertanyaan pemicu: "Bagaimana kita bisa menciptakan sebuah kampanye atau proyek tentang pentingnya {materi_spesifik}?"', experience: 'memahami' }, { phase: 'Fase 2: Merancang Proyek', activity: 'Siswa secara berkelompok merancang produk (misal: poster, video, presentasi) dan langkah-langkah penyelesaiannya.', experience: 'mengaplikasi' }, { phase: 'Fase 3: Menyusun Jadwal & Melaksanakan', activity: 'Siswa mengerjakan proyek sesuai jadwal, guru memfasilitasi dan memonitor.', experience: 'mengaplikasi' }, { phase: 'Fase 4: Menguji Hasil & Presentasi', activity: 'Setiap kelompok mempresentasikan hasil proyeknya di depan kelas.', experience: 'mengaplikasi' }, { phase: 'Fase 5: Evaluasi & Refleksi Pengalaman', activity: 'Siswa dan guru mengevaluasi produk dan proses, serta merefleksikan pembelajaran yang didapat.', experience: 'merefleksi' } ],
                'Sport Education Model (SEM)': [ { phase: 'Fase 1: Pengenalan Musim', activity: 'Guru memperkenalkan tema musim kompetisi (misal: "Liga Juara Kelas") dan durasinya.', experience: 'memahami' }, { phase: 'Fase 2: Pembentukan Tim', activity: 'Siswa dibagi menjadi tim tetap yang memiliki nama, kapten, dan yel-yel.', experience: 'mengaplikasi' }, { phase: 'Fase 3: Sesi Latihan', activity: 'Tim berlatih keterampilan {materi_spesifik} melalui berbagai pos latihan atau permainan drill.', experience: 'mengaplikasi' }, { phase: 'Fase 4: Pertandingan Resmi', activity: 'Tim saling berkompetisi dalam format liga atau turnamen. Ada wasit, pencatat skor, dan suporter.', experience: 'mengaplikasi' }, { phase: 'Fase 5: Festival & Selebrasi', activity: 'Puncak musim diakhiri dengan sebuah festival, pengumuman juara, dan pemberian penghargaan (tim terbaik, pemain paling sportif, dll).', experience: 'merefleksi' } ],
                'Default': [ { phase: 'Fase 1: Pemahaman Konsep', activity: 'Guru menjelaskan dan mendemonstrasikan konsep dasar dari {materi_spesifik}.', experience: 'memahami' }, { phase: 'Fase 2: Praktik Terbimbing', activity: 'Siswa mencoba mempraktikkan {materi_spesifik} dalam sebuah aktivitas atau permainan dengan panduan guru.', experience: 'mengaplikasi' }, { phase: 'Fase 3: Aplikasi & Eksplorasi', activity: 'Siswa menerapkan keterampilan dalam situasi yang lebih kompleks atau melakukan eksplorasi variasi gerak.', experience: 'mengaplikasi' }, { phase: 'Fase 4: Refleksi Pembelajaran', activity: 'Siswa diajak untuk merefleksikan apa yang telah dipelajari, kesulitan, dan perasaan mereka selama aktivitas.', experience: 'merefleksi' } ]
            };

            const ui = {
                form: document.getElementById('settingsForm'),
                fase: document.getElementById('fase'),
                kelas: document.getElementById('kelas'),
                semester: document.getElementById('semester'),
                elemenCp: document.getElementById('elemen-cp'),
                materiPembelajaran: document.getElementById('materi-pembelajaran'),
                materiSpesifik: document.getElementById('materi-spesifik'),
                modelPembelajaran: document.getElementById('model-pembelajaran'),
                output: { container: document.getElementById('outputContainer'), content: document.getElementById('modulContent'), placeholder: document.getElementById('placeholder'), loader: document.getElementById('loader'), actionButtonsWrapper: document.getElementById('action-buttons-wrapper'), copyBtn: document.getElementById('copy-btn'), backBtn: document.getElementById('back-btn') },
                gemini: { featuresSection: document.getElementById('gemini-features'), modal: document.getElementById('gemini-modal'), modalTitle: document.getElementById('gemini-modal-title'), modalContent: document.getElementById('gemini-modal-content'), modalClose: document.getElementById('gemini-modal-close'), modalCopy: document.getElementById('gemini-modal-copy'), warmupBtn: document.getElementById('gemini-warmup-btn'), materiBtn: document.getElementById('gemini-materi-btn'), quizBtn: document.getElementById('gemini-quiz-btn'), codingBtn: document.getElementById('gemini-coding-btn') }
            };

            function setupInitialOptions() {
                // Populate Elemen
                ui.elemenCp.innerHTML = '';
                elemenList.forEach(el => {
                    const option = document.createElement('option');
                    option.value = el;
                    option.textContent = el;
                    ui.elemenCp.appendChild(option);
                });

                // Populate Model Pembelajaran
                ui.modelPembelajaran.innerHTML = '';
                modelPembelajaranList.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    ui.modelPembelajaran.appendChild(option);
                });
            }

            function populateKelas() {
                const fase = ui.fase.value;
                const kelasUntukFase = kelasByFase[fase];
                ui.kelas.innerHTML = '';
                kelasUntukFase.forEach(k => {
                    const option = document.createElement('option');
                    option.value = k;
                    option.textContent = `${k}`;
                    ui.kelas.appendChild(option);
                });
                populateMateri();
            }

            function populateMateri() {
                const kelas = ui.kelas.value;
                const materiUntukKelas = materiByKelas[kelas] || {};
                ui.materiPembelajaran.innerHTML = '';
                const sortedMateri = Object.entries(materiUntukKelas).sort(([,a],[,b]) => a.text.localeCompare(b.text));

                for (const [key, value] of sortedMateri) {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = value.text;
                    ui.materiPembelajaran.appendChild(option);
                }
                updateSuggestionsFromMateri();
            }

            function updateSuggestionsFromMateri() {
                const kelas = ui.kelas.value;
                const materiKey = ui.materiPembelajaran.value;
                const materiData = materiByKelas[kelas] ? materiByKelas[kelas][materiKey] : null;

                if (materiData) {
                    if (materiData.elemenTerkait) {
                        ui.elemenCp.value = materiData.elemenTerkait;
                    }
                    if (materiData.saranSpesifik) {
                        ui.materiSpesifik.value = materiData.saranSpesifik;
                        ui.materiSpesifik.placeholder = `Contoh: ${materiData.saranSpesifik}`;
                    } else {
                        ui.materiSpesifik.value = '';
                        ui.materiSpesifik.placeholder = 'Contoh: Passing bawah, Guling depan';
                    }
                }
            }

            function getFormInputs() {
                return {
                    namaPenyusun: document.getElementById('nama-penyusun').value || '________________',
                    guruNip: document.getElementById('guru-nip').value || '________________',
                    kepsekNama: document.getElementById('kepsek-nama').value || '________________',
                    kepsekNip: document.getElementById('kepsek-nip').value || '________________',
                    institusi: document.getElementById('institusi').value || '________________',
                    lokasiTtd: document.getElementById('lokasi-ttd').value || '___________',
                    fase: ui.fase.value,
                    kelas: ui.kelas.value,
                    semester: ui.semester.value,
                    elemenCp: ui.elemenCp.value,
                    materiKey: ui.materiPembelajaran.value,
                    materiJudul: ui.materiPembelajaran.options[ui.materiPembelajaran.selectedIndex].text,
                    materiSpesifik: document.getElementById('materi-spesifik').value,
                    modelPembelajaran: ui.modelPembelajaran.value,
                    alokasiWaktu: {
                        jumlahPertemuan: parseInt(document.getElementById('jumlah-pertemuan').value, 10) || 1,
                        jpPerPertemuan: parseInt(document.getElementById('jp-per-pertemuan').value, 10) || 2,
                        menitPerJP: parseInt(document.getElementById('menit-per-jp').value, 10) || 40,
                    },
                };
            }

            function handleGenerate(event) {
                event.preventDefault();
                ui.output.placeholder.classList.add('hidden');
                ui.output.loader.classList.remove('hidden');
                ui.output.content.innerHTML = '';
                ui.output.actionButtonsWrapper.classList.add('hidden');
                setTimeout(generateModulAjar, 500);
            }
            
            function generateModulAjar() {
                const inputs = getFormInputs();
                if (!inputs.materiSpesifik) {
                    alert("Harap isi bagian 'Fokus Pembelajaran' untuk melanjutkan.");
                    ui.output.loader.classList.add('hidden');
                    ui.output.placeholder.classList.remove('hidden');
                    return;
                }
                ui.output.content.innerHTML = buildModulHtml(inputs);
                ui.output.loader.classList.add('hidden');
                ui.output.actionButtonsWrapper.classList.remove('hidden');
                ui.output.placeholder.classList.add('hidden');
                ui.output.container.scrollIntoView({ behavior: 'smooth' });
                lucide.createIcons();
            }

            // --- FUNGSI-FUNGSI PEMBANGUN KONTEN MODUL ---

            function getStyledLabel(type, text) {
                const baseStyle = `font-size: 0.75rem; font-weight: 700; padding: 0.2rem 0.6rem; border-radius: 9999px; margin-left: 0.5rem; vertical-align: middle; display: inline-block; margin-top: 0.25rem; border: 1px solid transparent;`;
                const styles = {
                    'joyful': 'background-color: #fef9c3; color: #713f12;', // yellow
                    'meaningful': 'background-color: #dcfce7; color: #14532d;', // green
                    'mindful': 'background-color: #e0e7ff; color: #312e81;', // indigo
                    'memahami': 'background-color: #cffafe; color: #155e75; border-color: #0e7490;', // cyan
                    'mengaplikasi': 'background-color: #dcfce7; color: #166534; border-color: #16a34a;', // green
                    'merefleksi': 'background-color: #ede9fe; color: #4c1d95; border-color: #5b21b6;', // violet
                };
                const finalStyle = baseStyle + (styles[type] || '');
                return `<span style="${finalStyle}">${text}</span>`;
            }

            function getLearningLabel(langkah) {
                const lowerLangkah = langkah.toLowerCase();
                const joyfulKeywords = ['permainan', 'bernyanyi', 'menampilkan', 'bermain', 'ice breaking', 'berkelompok', 'presentasi', 'kompetisi', 'yel-yel', 'festival', 'selebrasi'];
                const meaningfulKeywords = ['analisis', 'menganalisis', 'evaluasi', 'diskusi', 'refleksi', 'apersepsi', 'menyimpulkan', 'umpan balik', 'strategi'];
                const mindfulKeywords = ['praktik', 'latihan', 'mengamati', 'menirukan', 'mencatat', 'mengidentifikasi', 'menyampaikan tujuan', 'demonstrasi', 'drill', 'eksplorasi'];

                if (joyfulKeywords.some(keyword => lowerLangkah.includes(keyword))) return getStyledLabel('joyful', 'Joyful');
                if (meaningfulKeywords.some(keyword => lowerLangkah.includes(keyword))) return getStyledLabel('meaningful', 'Meaningful');
                if (mindfulKeywords.some(keyword => lowerLangkah.includes(keyword))) return getStyledLabel('mindful', 'Mindful');
                return '';
            }

            function getPengalamanLabel(type) {
                const labelMap = { 'memahami': 'Memahami', 'mengaplikasi': 'Mengaplikasi', 'merefleksi': 'Merefleksi' };
                return getStyledLabel(type, labelMap[type] || '');
            }

            function buildModulHtml(d) {
                const alokasi = d.alokasiWaktu;
                const totalJP = alokasi.jumlahPertemuan * alokasi.jpPerPertemuan;
                const alokasiWaktuText = `${totalJP} JP (${alokasi.jumlahPertemuan} Pertemuan @ ${alokasi.jpPerPertemuan} JP x ${alokasi.menitPerJP} Menit)`;
                const capaianPembelajaran = capaianPerElemen[d.elemenCp] ? capaianPerElemen[d.elemenCp][d.fase] : "Capaian tidak ditemukan.";
                
                const tujuanPembelajaran = `Peserta didik dapat menganalisis, mempraktikkan, dan menerapkan konsep ${d.materiSpesifik.toLowerCase()} dalam berbagai situasi pembelajaran yang relevan dan menantang.`;
                const pemahamanBermakna = `Dengan menguasai ${d.materiSpesifik.toLowerCase()}, saya dapat meningkatkan performa dalam permainan, memahami strategi, dan menerapkan gaya hidup aktif yang lebih baik.`;
                const pertanyaanPemantik = `<ul><li>Apa saja elemen kunci yang perlu diperhatikan saat melakukan ${d.materiSpesifik.toLowerCase()}?</li><li>Bagaimana penguasaan teknik ${d.materiSpesifik.toLowerCase()} dapat membantu kita dalam sebuah permainan atau aktivitas fisik?</li></ul>`;

                return `
                    <h1 class="main-title">MODUL AJAR PENDIDIKAN JASMANI, OLAHRAGA, DAN KESEHATAN (PJOK)</h1>
                    <h2 class="subtitle">${d.materiJudul.toUpperCase()}: FOKUS PADA ${d.materiSpesifik.toUpperCase()}</h2>
                    <hr class="main-divider">
                    
                    <h2 class="section-title">A. INFORMASI UMUM</h2>
                    <table class="info-table"><tbody>
                        <tr><td>Nama Penyusun</td><td>: ${d.namaPenyusun}</td></tr>
                        <tr><td>Nama Sekolah</td><td>: ${d.institusi}</td></tr>
                        <tr><td>Tahun Pelajaran</td><td>: ${new Date().getFullYear()}/${new Date().getFullYear() + 1}</td></tr>
                        <tr><td>Fase / Kelas</td><td>: ${d.fase} / ${d.kelas}</td></tr>
                        <tr><td>Elemen</td><td>: ${d.elemenCp}</td></tr>
                        <tr><td>Capaian Pembelajaran</td><td>: ${capaianPembelajaran}</td></tr>
                        <tr><td>Alokasi Waktu</td><td>: ${alokasiWaktuText}</td></tr>
                    </tbody></table>

                    <h2 class="section-title">B. KOMPONEN INTI</h2>
                    <h3 class="subsection-title">1. Tujuan Pembelajaran</h3>
                    <p>${tujuanPembelajaran}</p>
                    
                    <h3 class="subsection-title">2. Pemahaman Bermakna & Pertanyaan Pemantik</h3>
                    <p><strong>Pemahaman Bermakna:</strong> ${pemahamanBermakna}</p>
                    <p><strong>Pertanyaan Pemantik:</strong></p>${pertanyaanPemantik}

                    ${buildDelapanDimensi(d)}

                    <h2 class="section-title">C. KEGIATAN PEMBELAJARAN</h2>
                    ${buildKerangkaPembelajaran(d)}
                    <h3 class="subsection-title">2. Rincian Kegiatan Pembelajaran</h3>
                    ${buildLangkahPembelajaran(d)}
                    
                    <h2 class="section-title">D. ASESMEN / PENILAIAN</h2>
                    ${buildAsesmenSection(d)}

                    <h2 class="section-title">E. PENGAYAAN DAN REMEDIAL</h2>
                    ${buildPengayaanRemedial(d)}

                    <h2 class="section-title">F. REFLEKSI GURU DAN PESERTA DIDIK</h2>
                    ${buildRefleksi(d)}

                    <h2 class="section-title">G. LAMPIRAN</h2>
                    ${buildLkpd(d)}
                    ${buildAsesmenOtentik(d)}
                    ${buildCodingPJOKLampiran(d)}

                    <h2 class="section-title">H. GLOSARIUM & DAFTAR PUSTAKA</h2>
                    ${buildGlosarium(d)}
                    ${buildDaftarPustaka(d)}

                    <table style="width: 100%; border: none; margin-top: 60px; page-break-inside: avoid;"><tbody><tr>
                        <td style="width: 50%; text-align: center; border: none; vertical-align: top;">
                            Mengetahui,<br>Kepala Sekolah
                            <div style="height: 80px;"></div>
                            <strong style="text-decoration: underline;">${d.kepsekNama}</strong><br>
                            NIP. ${d.kepsekNip}
                        </td>
                        <td style="width: 50%; text-align: center; border: none; vertical-align: top;">
                            ${d.lokasiTtd}, ${new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}<br>
                            Guru Mata Pelajaran
                            <div style="height: 80px;"></div>
                            <strong style="text-decoration: underline;">${d.namaPenyusun}</strong><br>
                            NIP. ${d.guruNip}
                        </td>
                    </tr></tbody></table>
                `;
            }

            function buildDelapanDimensi(d) {
                const { elemenCp, modelPembelajaran } = d;
                const allDimensions = profilLulusanDatabase.desc;
                let relevantDimensions = new Set(profilLulusanDatabase.base);
                if (profilLulusanDatabase.byElemen[elemenCp]) {
                    profilLulusanDatabase.byElemen[elemenCp].forEach(dim => relevantDimensions.add(dim));
                }
                const modelMap = { 'Project-Based Learning (PjBL)': ['Kolaborasi', 'Penalaran Kritis', 'Kreativitas'], 'Problem-Based Learning (PBL)': ['Penalaran Kritis', 'Kolaborasi'], 'Cooperative Learning': ['Kolaborasi', 'Komunikasi'], 'Tactical Games Model': ['Penalaran Kritis', 'Kolaborasi'], 'Sport Education Model (SEM)': ['Kolaborasi', 'Kewargaan', 'Komunikasi'] };
                if (modelMap[modelPembelajaran]) {
                    modelMap[modelPembelajaran].forEach(dim => relevantDimensions.add(dim));
                }

                let html = `<h3 class="subsection-title">3. 8 Dimensi Profil Lulusan Pembelajaran Mendalam</h3>
                    <div class="info-box">
                        <p>Melalui tujuan, materi, dan model pembelajaran yang dipilih, pembelajaran ini secara khusus berfokus pada pengembangan dimensi-dimensi berikut:</p>
                        <ul>`;
                Array.from(relevantDimensions).sort().forEach(dim => {
                    html += `<li><strong>${dim}:</strong> ${allDimensions[dim]}</li>`;
                });
                html += `</ul></div>`;
                return html;
            }

            function buildKerangkaPembelajaran(d) {
                const kemitraanDesc = 'Melibatkan orang tua untuk mendukung aktivitas fisik anak di rumah dan komunitas sekolah dalam acara olahraga bersama (class meeting).';
                const teknologiDesc = 'Memanfaatkan pemutar musik untuk aktivitas gerak berirama, stopwatch digital untuk mengukur waktu, dan proyektor untuk menampilkan video contoh gerakan yang benar dan menarik.';
                const lingkunganDesc = 'Menciptakan suasana belajar yang suportif, aman untuk bergerak, dan menyenangkan. Lapangan atau ruang kelas ditata secara fleksibel untuk mendukung kerja individu, berpasangan, maupun kelompok.';
                const praktikPedagogisDesc = `Model <strong>${d.modelPembelajaran}</strong> dipilih untuk mendorong siswa aktif bergerak, berkolaborasi, dan memecahkan masalah dalam konteks permainan atau aktivitas fisik yang menyenangkan.`;

                return `
                    <h3 class="subsection-title">1. Kerangka Pembelajaran Mendalam</h3>
                    <p>Agar pembelajaran berjalan efektif, kerangka pembelajaran ini mencakup empat komponen utama:</p>
                    <ol>
                        <li><strong>Praktik Pedagogis:</strong> ${praktikPedagogisDesc}</li>
                        <li><strong>Kemitraan Pembelajaran:</strong> ${kemitraanDesc}</li>
                        <li><strong>Lingkungan Pembelajaran:</strong> ${lingkunganDesc}</li>
                        <li><strong>Pemanfaatan Teknologi Digital:</strong> ${teknologiDesc}</li>
                    </ol>
                `;
            }

            function buildLangkahPembelajaran(d) {
                let allMeetingsHTML = '';
                const { alokasiWaktu, modelPembelajaran, materiSpesifik } = d;
                const totalMenitPerPertemuan = alokasiWaktu.jpPerPertemuan * alokasiWaktu.menitPerJP;
                const durasi = { pendahuluan: Math.round(totalMenitPerPertemuan * 0.20), penutup: Math.round(totalMenitPerPertemuan * 0.20), inti: totalMenitPerPertemuan - (2 * Math.round(totalMenitPerPertemuan * 0.20)) };

                for (let i = 0; i < alokasiWaktu.jumlahPertemuan; i++) {
                    const pertemuanKe = i + 1;
                    let kegiatanHTML = `<h4>Pertemuan Ke-${pertemuanKe} (${alokasiWaktu.jpPerPertemuan} JP x ${alokasiWaktu.menitPerJP} Menit)</h4>`;
                    
                    kegiatanHTML += `<p><strong>Kegiatan Pendahuluan (${durasi.pendahuluan} Menit):</strong></p><ol>
                        <li>Guru membuka pelajaran, berdoa, memeriksa kehadiran. ${getLearningLabel("ice breaking")}</li>
                        <li>Apersepsi: Guru mengaitkan pengalaman siswa dengan topik dan melakukan asesmen diagnostik awal. ${getLearningLabel("apersepsi")}</li>
                        <li>Guru menyampaikan tujuan pembelajaran spesifik yang akan dicapai. ${getPengalamanLabel('memahami')} ${getLearningLabel("menyampaikan tujuan")}</li>
                        <li>Pemanasan dengan permainan yang relevan untuk mempersiapkan fisik dan mental. ${getLearningLabel("permainan")}</li>
                    </ol>`;

                    kegiatanHTML += `<p><strong>Kegiatan Inti (${durasi.inti} Menit) - Sintaks Model ${modelPembelajaran}:</strong></p>`;
                    
                    let modelSintaks = sintaksDatabase[modelPembelajaran] || sintaksDatabase['Default'];
                    
                    kegiatanHTML += `<table style="width: 100%; border-collapse: collapse; margin-top: 1em; font-size: 0.9em; page-break-inside: avoid;">
                        <thead style="background-color: #f9fafb;"><tr>
                            <th style="width: 25%; border: 1px solid #d1d5db; padding: 0.75rem; text-align: left; font-weight: 600;">Fase Pembelajaran</th>
                            <th style="border: 1px solid #d1d5db; padding: 0.75rem; text-align: left; font-weight: 600;">Aktivitas Guru dan Peserta Didik</th>
                            <th style="width: 20%; border: 1px solid #d1d5db; padding: 0.75rem; text-align: left; font-weight: 600;">Pengalaman Belajar</th>
                        </tr></thead><tbody>`;

                    modelSintaks.forEach(step => {
                        const activityText = step.activity.replace(/{materi_spesifik}/g, `<strong>${materiSpesifik}</strong>`);
                        kegiatanHTML += `<tr>
                            <td style="border: 1px solid #d1d5db; padding: 0.75rem; font-weight: 600; vertical-align: top;">${step.phase}</td>
                            <td style="border: 1px solid #d1d5db; padding: 0.75rem; vertical-align: top;">${activityText} ${getLearningLabel(activityText)}</td>
                            <td style="border: 1px solid #d1d5db; padding: 0.75rem; vertical-align: top;">${getPengalamanLabel(step.experience)}</td>
                        </tr>`;
                    });

                    kegiatanHTML += `</tbody></table>`;
                    
                    kegiatanHTML += `<p><strong>Kegiatan Penutup (${durasi.penutup} Menit):</strong></p><ol>
                        <li>Pendinginan dengan gerakan peregangan statis. ${getLearningLabel("mindful")}</li>
                        <li>Siswa dan guru menyimpulkan dan merefleksikan kembali seluruh proses pembelajaran. ${getPengalamanLabel('merefleksi')} ${getLearningLabel("refleksi")}</li>
                        <li>Guru memberikan umpan balik umum dan apresiasi terhadap usaha seluruh siswa.</li>
                        <li>Guru menutup pelajaran dengan doa dan menyampaikan gambaran pertemuan berikutnya.</li>
                    </ol>`;

                    allMeetingsHTML += kegiatanHTML;
                    if (i < alokasiWaktu.jumlahPertemuan - 1) {
                        allMeetingsHTML += '<hr style="border-top: 1px dashed #ccc; margin: 2rem 0;">';
                    }
                }
                return allMeetingsHTML;
            }

            function buildAsesmenSection(d) {
                 return `
                     <table class="info-table">
                         <thead><tr><th>Jenis Asesmen</th><th>Tujuan</th><th>Teknik & Instrumen</th></tr></thead>
                         <tbody>
                             <tr>
                                 <td><strong>Diagnostik</strong></td>
                                 <td>Mengidentifikasi kemampuan awal dan kesiapan siswa.</td>
                                 <td><strong>Teknik:</strong> Tanya jawab, permainan singkat.<br><strong>Instrumen:</strong> Pertanyaan pemantik.</td>
                             </tr>
                             <tr>
                                 <td><strong>Formatif</strong></td>
                                 <td>Memantau kemajuan belajar dan memberikan umpan balik selama proses.</td>
                                 <td><strong>Teknik:</strong> Observasi, penilaian diri/teman.<br><strong>Instrumen:</strong> Lembar observasi sikap (kolaborasi, sportivitas), catatan anekdotal.</td>
                             </tr>
                             <tr>
                                 <td><strong>Sumatif</strong></td>
                                 <td>Mengukur ketercapaian tujuan di akhir pembelajaran.</td>
                                 <td><strong>Teknik:</strong> Unjuk kerja, tes keterampilan.<br><strong>Instrumen:</strong> Format Penilaian Otentik (lihat lampiran).</td>
                             </tr>
                         </tbody>
                     </table>`;
            }

            function buildPengayaanRemedial(d) {
                const pengayaanText = `Siswa yang sudah mahir diminta untuk mencoba variasi gerakan ${d.materiSpesifik.toLowerCase()} yang lebih kompleks (misal: dengan rintangan, tempo lebih cepat, atau dikombinasikan dengan gerakan lain) dan menjadi tutor sebaya bagi temannya.`;
                const remedialText = `Siswa yang masih kesulitan diberikan bimbingan ulang secara personal atau dalam kelompok kecil. Guru memberikan contoh yang dipecah menjadi bagian-bagian kecil (chunking) dan memberikan lebih banyak kesempatan untuk berlatih dengan umpan balik langsung.`;
                return `<p><strong>Pengayaan:</strong><br>${pengayaanText}</p><p class="mt-4"><strong>Remedial:</strong><br>${remedialText}</p>`;
            }

            function buildRefleksi(d) {
                return `
                    <h5><strong>Refleksi Guru</strong></h5>
                    <ul>
                        <li>Apakah seluruh siswa mengikuti pelajaran dengan antusias?</li>
                        <li>Apakah siswa mengalami kesulitan dalam mengikuti langkah-langkah pada model pembelajaran "${d.modelPembelajaran}"?</li>
                        <li>Apakah alokasi waktu yang disediakan cukup untuk semua tahapan pembelajaran?</li>
                    </ul>
                    <h5 class="mt-6"><strong>Refleksi Peserta Didik</strong></h5>
                    <ul>
                        <li>Pada bagian mana dari pelajaran hari ini yang kamu rasa paling menantang?</li>
                        <li>Apa kesulitan terbesar yang kamu temui saat mencoba ${d.materiSpesifik.toLowerCase()}?</li>
                        <li>Apa yang akan kamu lakukan agar bisa lebih baik lagi pada pertemuan berikutnya?</li>
                    </ul>`;
            }
            
            function buildLkpd(d) {
                const lkpdDatabase = {
                    'default': { title: "Lembar Kerja Pengamatan", tujuan: "Mengamati dan menilai kemampuan siswa dalam {materi_spesifik}.", alat: ["Area/lapangan", "Alat tulis"], langkah: ["Amati setiap siswa saat melakukan aktivitas.", "Berikan tanda centang () pada kolom yang sesuai.", "Tuliskan catatan spesifik."], tabel: `<table class="lkpd-table"><thead><tr><th rowspan="2">Nama Siswa</th><th colspan="3">Aspek yang Diamati</th><th rowspan="2">Catatan</th></tr><tr><th>Persiapan</th><th>Proses</th><th>Hasil</th></tr></thead><tbody><tr><td></td><td></td><td></td><td></td></tr></tbody></table>` },
                    'sepak-bola-7': { title: "LKPD Observasi Permainan Sepak Bola", tujuan: "Mengamati kemampuan siswa dalam membuat keputusan dan menerapkan teknik {materi_spesifik} dalam situasi permainan.", alat: ["Bola sepak", "Cone", "Rompi", "Alat tulis"], langkah: ["Bagi siswa ke dalam tim untuk bermain 4 vs 4.", "Fokus pengamatan pada efektivitas keputusan yang diambil siswa.", "Gunakan tabel ceklis untuk mencatat frekuensi keputusan yang efektif."], tabel: `<table class="lkpd-table"><thead><tr><th rowspan="2">Nama Siswa</th><th colspan="3">Keputusan Saat Menguasai Bola</th><th rowspan="2">Catatan</th></tr><tr><th>Passing Akurat</th><th>Dribbling Efektif</th><th>Menembak Tepat</th></tr></thead><tbody><tr><td></td><td></td><td></td><td></td></tr></tbody></table>` },
                    'pola-makan-sehat-7': { title: "LKPD Analisis Studi Kasus Pola Hidup", tujuan: "Menganalisis skenario untuk mengidentifikasi perilaku sehat dan tidak sehat.", alat: ["Lembar studi kasus", "Alat tulis"], langkah: ["Bacalah studi kasus yang diberikan.", "Identifikasi perilaku yang mendukung dan menghambat pola hidup sehat.", "Diskusikan dalam kelompok dan rumuskan rekomendasi perbaikan."], tabel: `<table class="lkpd-table"><thead><tr><th>Studi Kasus</th><th>Perilaku Tidak Sehat</th><th>Risiko Kesehatan</th><th>Rekomendasi Perbaikan</th></tr></thead><tbody><tr><td></td><td></td><td></td><td></td></tr></tbody></table><p class="text-sm mt-2"><em>*Untuk membuat LKPD interaktif, gunakan <a href="https://www.google.com/forms/about/" target="_blank" class="text-indigo-600 hover:underline">Google Forms</a> untuk survei atau kuis.</em></p>` },
                    'senam-lantai-7': { title: "LKPD Penilaian Rangkaian Gerak Senam Lantai", tujuan: "Menilai kemampuan siswa dalam melakukan dan merangkai beberapa gerakan dasar senam lantai ({materi_spesifik}).", alat: ["Matras senam", "Alat tulis"], langkah: ["Setiap siswa diminta untuk melakukan rangkaian gerak yang telah ditentukan.", "Guru menilai kualitas setiap gerakan berdasarkan kriteria yang ada.", "Berikan skor pada setiap aspek dan tuliskan umpan balik yang membangun."], tabel: `<table class="lkpd-table"><thead><tr><th rowspan="2">Nama Siswa</th><th colspan="4">Kualitas Gerakan ({materi_spesifik})</th><th rowspan="2">Total Skor</th></tr><tr><th>Keseimbangan</th><th>Kelenturan</th><th>Keberanian</th><th>Kerapian Teknik</th></tr></thead><tbody><tr><td></td><td></td><td></td><td></td><td></td><td></td></tr></tbody></table>` }
                };
                const lkpdData = lkpdDatabase[d.materiKey] || lkpdDatabase.default;
                const lkpdHTML = `<h3>1. Lembar Kerja Peserta Didik (LKPD)</h3><div class="lampiran-box">
                    <h4>${lkpdData.title.replace(/{materi_spesifik}/g, d.materiSpesifik)}</h4>
                    <p><strong>Tujuan:</strong> ${lkpdData.tujuan.replace(/{materi_spesifik}/g, d.materiSpesifik)}</p>
                    <p><strong>Alat & Bahan:</strong> ${Array.isArray(lkpdData.alat) ? lkpdData.alat.join(', ') : ''}</p>
                    <hr class="my-2">
                    <h5><strong>Langkah Kerja:</strong></h5>
                    <ol>${Array.isArray(lkpdData.langkah) ? lkpdData.langkah.map(l => `<li>${l}</li>`).join('') : ''}</ol>
                    ${lkpdData.tabel.replace(/{materi_spesifik}/g, d.materiSpesifik)}
                </div>`;
                return lkpdHTML;
            }

            function buildAsesmenOtentik(d) {
                const criteria = [
                    { name: 'Sikap Awal', desc: 'Posisi tubuh awal sebelum melakukan gerakan.' },
                    { name: 'Pelaksanaan Gerak', desc: 'Kualitas dan kebenaran gerakan inti.' },
                    { name: 'Sikap Akhir', desc: 'Posisi tubuh setelah selesai melakukan gerakan.' },
                    { name: 'Koordinasi & Kelancaran', desc: 'Keharmonisan dan kelancaran seluruh rangkaian gerak.' }
                ];

                let rubrikHTML = `<h3>2. Format Penilaian Otentik (Sumatif)</h3><div class="lampiran-box">
                    <p><strong>Bentuk Asesmen:</strong> Unjuk Kerja: Praktik Keterampilan ${d.materiSpesifik}</p>
                    <h5 style="margin-top:1.5rem;"><strong>Rubrik Penilaian Keterampilan:</strong></h5>
                    <table style="font-size:0.85em;">
                        <thead><tr><th>Kriteria</th><th>Skor 4 (Sangat Baik)</th><th>Skor 3 (Baik)</th><th>Skor 2 (Cukup)</th><th>Skor 1 (Perlu Bimbingan)</th></tr></thead>
                        <tbody>`;
                
                criteria.forEach(c => {
                    rubrikHTML += `<tr>
                        <td><strong>${c.name}</strong><br><small>${c.desc}</small></td>
                        <td>Menunjukkan penguasaan yang sangat baik, konsisten, dan benar.</td>
                        <td>Menunjukkan penguasaan yang baik, namun terkadang ada sedikit kesalahan.</td>
                        <td>Menunjukkan penguasaan dasar, namun masih banyak kekurangan.</td>
                        <td>Memerlukan bimbingan intensif pada hampir semua aspek.</td>
                    </tr>`;
                });

                rubrikHTML += `</tbody></table></div>`;
                return rubrikHTML;
            }

            function buildCodingPJOKLampiran(d) {
                return `<h3>3. Aktivitas Pembelajaran Coding PJOK (Unplugged)</h3>
                    <div class="lampiran-box">
                        <p class="font-semibold text-gray-700">Petunjuk:</p>
                        <p>Aktivitas di bawah ini adalah kegiatan pengayaan yang menghubungkan PJOK dengan berpikir komputasional. Gunakan tombol <strong class="text-sky-600">'Ide Coding PJOK'</strong> pada Fitur Canggih untuk menghasilkan ide aktivitas yang relevan, lalu salin dan tempelkan hasilnya di sini.</p>
                        <div class="mt-4 p-4 border-2 border-dashed rounded-md bg-gray-50 text-center text-gray-500">
                            [ Tempelkan hasil dari 'Ide Coding PJOK' di sini ]
                        </div>
                    </div>`;
            }
            
            function buildGlosarium(d) {
                const glosariumDatabase = { 'default': { "Gerak Lokomotor": "Gerakan berpindah tempat.", "Gerak Non-lokomotor": "Gerakan di tempat.", "Gerak Manipulatif": "Gerakan melibatkan objek." }, 'sepak-bola': { "Passing": "Mengoper bola ke teman.", "Controlling": "Menghentikan laju bola.", "Dribbling": "Menggiring bola.", "Taktik": "Rencana memenangkan permainan." }, 'bola-voli': { "Servis": "Pukulan awal untuk memulai permainan.", "Passing Bawah": "Menerima bola dengan kedua lengan bawah dirapatkan.", "Passing Atas": "Mengoper bola menggunakan jari-jari tangan di atas kepala.", "Smash/Spike": "Pukulan keras menukik ke area lawan." }, 'bola-basket': { "Dribbling": "Menggiring bola dengan cara memantul-mantulkannya ke lantai.", "Shooting": "Melempar bola ke arah keranjang untuk mencetak poin.", "Lay-up": "Tembakan yang dilakukan dari jarak dekat dengan keranjang.", "Pivot": "Gerakan memutar badan dengan salah satu kaki sebagai tumpuan." }, 'kasti': { "Melempar": "Gerakan melontarkan bola ke arah tertentu.", "Menangkap": "Gerakan menghentikan dan menguasai bola yang datang.", "Memukul": "Gerakan mengayunkan tongkat untuk mengenai bola.", "Base": "Tempat hinggap bagi pelari setelah memukul bola." }, 'bulutangkis': { "Servis": "Pukulan awal untuk memulai permainan.", "Smash": "Pukulan keras dan menukik ke area lawan.", "Dropshot": "Pukulan tipuan yang jatuh tipis di dekat net.", "Netting": "Permainan di dekat net." }, 'tenis-meja': { "Bet": "Alat pemukul dalam tenis meja.", "Spin": "Putaran bola yang dihasilkan dari pukulan.", "Chop": "Pukulan bertahan dengan gerakan seperti menebang.", "Rally": "Pukulan bola bolak-balik antara pemain." }, 'atletik-jalan-cepat': { "Fase Tumpuan Dua Kaki": "Saat kedua kaki menyentuh tanah secara bersamaan.", "Fase Tarikan": "Gerakan menarik kaki ke depan.", "Langkah": "Gerakan kaki dari satu titik ke titik berikutnya.", "Kontak Tanah": "Salah satu kaki harus selalu menyentuh tanah." }, 'atletik-lari-pendek': { "Start Jongkok": "Posisi awal sebelum berlari pada lari jarak pendek.", "Aba-aba": "Isyarat untuk memulai lari (Bersedia, Siap, Ya!).", "Finish": "Melewati garis akhir perlombaan.", "Sprinter": "Pelari jarak pendek." }, 'atletik-lompat-jauh': { "Awalan": "Lari ancang-ancang sebelum melompat.", "Tolakan": "Gerakan menolak pada papan tumpuan dengan satu kaki.", "Melayang di Udara": "Sikap badan saat berada di udara.", "Pendaratan": "Cara mendarat di bak pasir dengan kedua kaki." }, 'atletik-tolak-peluru': { "Gaya O'Brien": "Gaya menolak peluru dengan membelakangi sektor tolakan.", "Gaya Ortodoks": "Gaya menolak peluru dengan menyamping sektor tolakan.", "Sektor Tolakan": "Area lingkaran tempat atlet melakukan tolakan.", "Peluru": "Bola logam yang digunakan dalam olahraga tolak peluru." }, 'beladiri-silat': { "Kuda-kuda": "Posisi dasar tumpuan kaki untuk memperkokoh posisi tubuh.", "Pukulan": "Serangan menggunakan tangan.", "Tendangan": "Serangan menggunakan kaki.", "Tangkisan": "Gerakan bertahan untuk menahan serangan lawan." }, 'kebugaran-jasmani': { "Kekuatan": "Kemampuan otot untuk menahan beban.", "Daya Tahan": "Kemampuan untuk melakukan kerja dalam waktu yang lama.", "Kelincahan": "Kemampuan mengubah arah gerak dengan cepat.", "Interval Training": "Latihan dengan selang waktu antara kerja dan istirahat." }, 'senam-lantai': { "Guling Depan": "Gerakan berguling ke depan dengan tumpuan tengkuk.", "Keseimbangan": "Kemampuan mempertahankan posisi tubuh.", "Kelenturan": "Kemampuan tubuh untuk melakukan gerak dalam ruang gerak sendi.", "Meroda": "Gerakan memutar tubuh ke samping dengan tumpuan tangan dan kaki." }, 'senam-irama': { "Irama": "Ketukan atau tempo yang menjadi acuan gerakan.", "Gerak Langkah": "Berbagai jenis langkah dasar dalam senam irama.", "Ayunan Lengan": "Gerakan lengan yang selaras dengan langkah dan irama.", "Koordinasi": "Keterpaduan antara gerak tangan, kaki, dan irama musik." }, 'renang-dada': { "Gerak Kaki Katak": "Gerakan kaki yang menyerupai gerakan kaki katak saat berenang.", "Pengambilan Napas": "Teknik mengambil napas ke atas permukaan air.", "Strok (Stroke)": "Satu siklus gerakan lengkap dari tangan dan kaki.", "Meluncur": "Posisi awal setelah start atau saat berbalik." }, 'pola-makan-sehat': { "Kalori": "Satuan energi dalam makanan.", "Gizi Seimbang": "Komposisi zat gizi sesuai kebutuhan tubuh.", "Perilaku Sedenter": "Gaya hidup kurang gerak.", "Obesitas": "Kelebihan berat badan akibat penumpukan lemak."}, 'pergaulan-bebas': { "NAPZA": "Singkatan dari Narkotika, Psikotropika, dan Zat Adiktif lainnya.", "Seks Bebas": "Perilaku seksual yang dilakukan di luar ikatan pernikahan.", "Kesehatan Reproduksi": "Keadaan sehat secara fisik, mental, dan sosial yang berkaitan dengan sistem reproduksi.", "Asertif": "Sikap mampu berkomunikasi dengan jujur dan tegas namun tetap menghargai orang lain." } };
                const getGlosariumKey = (materiKey) => { if (!materiKey) return 'default'; if (materiKey.includes('sepak-bola')) return 'sepak-bola'; if (materiKey.includes('bola-voli')) return 'bola-voli'; if (materiKey.includes('bola-basket')) return 'bola-basket'; if (materiKey.includes('kasti')) return 'kasti'; if (materiKey.includes('bulutangkis')) return 'bulutangkis'; if (materiKey.includes('tenis-meja')) return 'tenis-meja'; if (materiKey.includes('jalan-cepat')) return 'atletik-jalan-cepat'; if (materiKey.includes('lari')) return 'atletik-lari-pendek'; if (materiKey.includes('lompat-jauh')) return 'atletik-lompat-jauh'; if (materiKey.includes('tolak-peluru')) return 'atletik-tolak-peluru'; if (materiKey.includes('beladiri-silat')) return 'beladiri-silat'; if (materiKey.includes('kebugaran')) return 'kebugaran-jasmani'; if (materiKey.includes('senam-lantai')) return 'senam-lantai'; if (materiKey.includes('senam-irama') || materiKey.includes('gerak-berirama')) return 'senam-irama'; if (materiKey.includes('renang-dada')) return 'renang-dada'; if (materiKey.includes('pola-makan')) return 'pola-makan-sehat'; if (materiKey.includes('pergaulan-bebas')) return 'pergaulan-bebas'; return 'default'; };
                const glosariumKey = getGlosariumKey(d.materiKey);
                const glosariumData = glosariumDatabase[glosariumKey] || glosariumDatabase.default;
                let glosariumHTML = `<h3>1. Glosarium</h3><div class="lampiran-box"><ul>`;
                Object.entries(glosariumData).forEach(([istilah, definisi]) => {
                    glosariumHTML += `<li><strong>${istilah}:</strong> ${definisi}</li>`;
                });
                glosariumHTML += `</ul></div>`;
                return glosariumHTML;
            }

            function buildDaftarPustaka(d) {
                const year = new Date().getFullYear();
                return `<h3 class="subsection-title">2. Daftar Pustaka</h3><div class="lampiran-box"><ul>
                    <li>Muhajir, dkk. (${year}). <em>Buku Panduan Guru PJOK untuk SMP Kelas ${d.kelas}</em>. Jakarta: Kemendikbudristek.</li>
                    <li>Muhajir, dkk. (${year}). <em>Buku Siswa PJOK untuk SMP Kelas ${d.kelas}</em>. Jakarta: Kemendikbudristek.</li>
                    <li>YouTube & Platform Video Edukasi lainnya untuk referensi visual.</li>
                </ul></div>`;
            }

            // --- FUNGSI-FUNGSI BANTUAN AI (GEMINI) ---
            // PERUBAHAN PENTING: Fungsi ini diubah untuk keamanan.
            // Sekarang memanggil 'proxy' di Netlify, bukan langsung ke Google.
            async function callGemini(prompt) {
                const proxyUrl = '/.netlify/functions/gemini-proxy';
                const payload = { prompt: prompt };

                try {
                    const response = await fetch(proxyUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `Error dari server: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    return result.text; // Fungsi proxy akan mengembalikan teks langsung

                } catch (error) {
                    console.error("callGemini via Proxy Error:", error);
                    return `Terjadi kesalahan saat menghubungi asisten AI: ${error.message}. Mohon periksa koneksi atau coba lagi nanti.`;
                }
            }

            function markdownToHtml(text) {
                const lines = text.replace(/\r/g, '').split('\n');
                let html = '';
                let inList = null;
                function closeList() { if (inList) { html += `</${inList}>`; inList = null; } }
                for (let line of lines) {
                    line = line.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>');
                    const trimmedLine = line.trim();
                    if (trimmedLine.startsWith('### ')) { closeList(); html += `<h3>${line.substring(4)}</h3>`; continue; }
                    if (trimmedLine.startsWith('## ')) { closeList(); html += `<h2>${line.substring(3)}</h2>`; continue; }
                    if (trimmedLine.startsWith('# ')) { closeList(); html += `<h1>${line.substring(2)}</h1>`; continue; }
                    const isUl = trimmedLine.startsWith('- ') || trimmedLine.startsWith('* ');
                    const isOl = /^\d+\.\s/.test(trimmedLine);
                    if (isUl) { if (inList !== 'ul') { closeList(); html += '<ul>'; inList = 'ul'; } html += `<li>${line.substring(line.indexOf(' ') + 1)}</li>`; } 
                    else if (isOl) { if (inList !== 'ol') { closeList(); html += '<ol>'; inList = 'ol'; } html += `<li>${line.substring(line.indexOf(' ') + 1)}</li>`; } 
                    else { closeList(); if (trimmedLine.length > 0) { html += `<p>${line}</p>`; } }
                }
                closeList(); return html;
            }

            function showModal(title, content) {
                ui.gemini.modalTitle.innerText = title;
                ui.gemini.modalContent.innerHTML = markdownToHtml(content);
                ui.gemini.modal.classList.remove('hidden');
                lucide.createIcons();
            }

            function showLoadingModal(title, icon) {
                ui.gemini.modalTitle.innerText = title;
                ui.gemini.modalContent.innerHTML = `<p class="text-center animate-pulse text-xl">${icon} Memproses permintaan Anda...</p>`;
                ui.gemini.modal.classList.remove('hidden');
            }
            
            function setupGeminiListeners() {
                const geminiPromptSuffix = " Format jawaban dalam bentuk markdown (gunakan ### untuk subjudul, * atau 1. untuk list, dan **teks** untuk bold).";
                
                ui.gemini.warmupBtn.addEventListener('click', async () => { 
                    const d = getFormInputs(); 
                    const title = `Ide Pemanasan untuk ${d.materiJudul}`; 
                    showLoadingModal(title, '');
                    const prompt = `Sebagai guru PJOK SMP, berikan 3 ide permainan pemanasan yang kreatif, menyenangkan, dan relevan untuk materi '${d.materiJudul}' (fokus: ${d.materiSpesifik}) untuk siswa Kelas ${d.kelas} (Fase D). Jelaskan tujuan dan cara bermainnya.` + geminiPromptSuffix; 
                    const result = await callGemini(prompt); 
                    showModal(title, result); 
                });

                ui.gemini.materiBtn.addEventListener('click', async () => { 
                    const d = getFormInputs(); 
                    const title = `Materi Mendalam: ${d.materiJudul}`; 
                    showLoadingModal(title, '');
                    const prompt = `Sebagai guru PJOK SMP, jelaskan materi '${d.materiJudul}' dengan fokus pada '${d.materiSpesifik}' dengan bahasa yang mudah dipahami remaja Kelas ${d.kelas}. Sertakan analogi dari olahraga profesional, poin-poin kunci, dan kesalahan umum yang harus dihindari.` + geminiPromptSuffix; 
                    const result = await callGemini(prompt); 
                    showModal(title, result); 
                });

                ui.gemini.quizBtn.addEventListener('click', async () => { 
                    const d = getFormInputs(); 
                    const title = `Kuis Interaktif: ${d.materiJudul}`; 
                    showLoadingModal(title, '');
                    const prompt = `Sebagai guru PJOK SMP, buat 5 soal kuis HOTS (Higher Order Thinking Skills) pilihan ganda (A, B, C, D) untuk menguji pemahaman materi '${d.materiJudul}' (fokus: '${d.materiSpesifik}') untuk siswa Kelas ${d.kelas}. Sertakan kunci jawaban dan penjelasan singkat untuk setiap jawaban.` + geminiPromptSuffix; 
                    const result = await callGemini(prompt); 
                    showModal(title, result); 
                });

                ui.gemini.codingBtn.addEventListener('click', async () => { 
                    const d = getFormInputs(); 
                    const title = `Ide Unplugged Coding (Tanpa Komputer)`; 
                    showLoadingModal(title, '');
                    const prompt = `Sebagai guru PJOK inovatif, berikan 2 ide konkret untuk aktivitas "Unplugged Coding" yang terintegrasi dengan materi pelajaran PJOK. Fokus HANYA pada aktivitas fisik.
                    Konteks Pembelajaran:
                    - Kelas: ${d.kelas} SMP (Fase D)
                    - Materi Pelajaran: '${d.materiJudul}' (Fokus: ${d.materiSpesifik})
                    - Model Pembelajaran: '${d.modelPembelajaran}'
                    Untuk setiap ide, jelaskan:
                    1.  **Nama Aktivitas:**
                    2.  **Konsep Coding yang Diajarkan:** (Contoh: Algoritma/Urutan, Loop/Perulangan, Kondisional/Jika-Maka)
                    3.  **Integrasi dengan Materi PJOK:**
                    4.  **Langkah-langkah Pelaksanaan:**
                    ` + geminiPromptSuffix;
                    const result = await callGemini(prompt); 
                    showModal(title, result); 
                });
            }

            // --- FUNGSI-FUNGSI UTILITAS & EVENT LISTENERS ---
            function copyToClipboard(htmlContent, plainText, buttonElement, successIcon, originalContent) {
                const listener = (ev) => {
                    ev.preventDefault();
                    ev.clipboardData.setData('text/html', htmlContent);
                    ev.clipboardData.setData('text/plain', plainText);
                };
                document.addEventListener('copy', listener);
                document.execCommand('copy');
                document.removeEventListener('copy', listener);

                buttonElement.innerHTML = successIcon;
                lucide.createIcons();

                setTimeout(() => {
                    buttonElement.innerHTML = originalContent;
                    lucide.createIcons();
                }, 2000);
            }

            function setupEventListeners() {
                ui.kelas.addEventListener('change', populateMateri);
                ui.materiPembelajaran.addEventListener('change', updateSuggestionsFromMateri);
                ui.form.addEventListener('submit', handleGenerate);

                ui.gemini.modalClose.addEventListener('click', () => ui.gemini.modal.classList.add('hidden'));
                
                ui.gemini.modalCopy.addEventListener('click', () => {
                    const styleContent = document.querySelector('style').innerHTML;
                    const modalHtmlContent = ui.gemini.modalContent.innerHTML;
                    const fullHtml = `<!DOCTYPE html><html lang="id"><head><meta charset="UTF-8"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet"><style>${styleContent}</style></head><body style="padding: 1rem; font-family: 'Poppins', sans-serif;" class="prose">${modalHtmlContent}</body></html>`;
                    const plainText = ui.gemini.modalContent.innerText;
                    copyToClipboard(fullHtml, plainText, ui.gemini.modalCopy, '<i data-lucide="check" class="inline-block mr-2 h-5 w-5"></i> Tersalin!', 'Salin Teks');
                });
                
                ui.output.copyBtn.addEventListener('click', () => {
                    const styleContent = document.querySelector('style').innerHTML;
                    const htmlContent = ui.output.content.innerHTML;
                    const fullHtml = `<!DOCTYPE html><html lang="id"><head><meta charset="UTF-8"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet"><style>${styleContent.replace(/\.no-print\s*\{[^}]*\}/g, '')}</style></head><body style="padding: 1rem; font-family: 'Poppins', sans-serif;" class="prose">${htmlContent}</body></html>`;
                    copyToClipboard(fullHtml, ui.output.content.innerText, ui.output.copyBtn, '<i data-lucide="check" class="mr-2 h-4 w-4"></i> Tersalin!', '<i data-lucide="copy" class="mr-2 h-4 w-4"></i> Salin');
                });

                ui.output.backBtn.addEventListener('click', () => {
                    ui.output.content.innerHTML = '';
                    ui.output.placeholder.classList.remove('hidden');
                    ui.output.actionButtonsWrapper.classList.add('hidden');
                });
            }

            // --- INISIALISASI APLIKASI ---
            setupInitialOptions();
            populateKelas();
            setupEventListeners();
            setupGeminiListeners();
        });
    </script>
</body>
</html>